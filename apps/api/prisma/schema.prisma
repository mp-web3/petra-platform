generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model EmailLog {
  id             String      @id @default(cuid())
  emailType      EmailType
  orderId        String?     @map("order_id")
  campaign       String?     @map("campaign")
  recipientEmail String      @map("recipient_email")
  status         EmailStatus
  providerId     String?     @map("provider_id")
  errorMessage   String?     @map("error_message")
  sentAt         DateTime    @default(now()) @map("sent_at")
  deliveredAt    DateTime?   @map("delivered_at")
  openedAt       DateTime?   @map("opened_at")
  order          Order?      @relation(fields: [orderId], references: [id])

  @@map("email_logs")
}

model User {
  id                     String            @id @default(cuid())
  email                  String            @unique
  name                   String?
  role                   UserRole          @default(CLIENT)
  stripeCustomerId       String?           @unique @map("stripe_customer_id")
  createdAt              DateTime          @default(now()) @map("created_at")
  updatedAt              DateTime          @updatedAt @map("updated_at")
  activatedAt            DateTime?         @map("activated_at")
  activationReminderSent Boolean           @default(false)
  emailVerified          Boolean           @default(false)
  password               String?
  activationTokens       ActivationToken[]
  orders                 Order[]
  subscriptions          Subscription[]

  @@map("users")
}

model Order {
  id                    String       @id @default(cuid())
  userId                String?      @map("user_id")
  planId                String       @map("plan_id")
  amount                Int
  currency              String
  status                OrderStatus
  stripeSessionId       String       @unique @map("stripe_session_id")
  stripePaymentIntentId String?      @unique @map("stripe_payment_intent_id")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")
  signUpStatus          SignUpStatus @default(PENDING) @map("sign_up_status")
  consent               Consent?
  emailLogs             EmailLog[]
  user                  User?        @relation(fields: [userId], references: [id])

  @@map("orders")
}

model Consent {
  id                       String   @id @default(cuid())
  orderId                  String   @unique @map("order_id")
  tosAccepted              Boolean  @map("tos_accepted")
  marketingOptIn           Boolean? @map("marketing_opt_in")
  ipAddress                String?  @map("ip_address")
  userAgent                String?  @map("user_agent")
  createdAt                DateTime @default(now()) @map("created_at")
  disclosurePrivacyVersion String   @default("v1.0") @map("disclosure_privacy_version")
  disclosureTosVersion     String   @map("disclosure_tos_version")
  privacyAccepted          Boolean  @default(true) @map("privacy_accepted")
  order                    Order    @relation(fields: [orderId], references: [id])

  @@map("consents")
}

model Subscription {
  id                   String               @id @default(cuid())
  userId               String               @map("user_id")
  planType             SubscriptionPlanType @map("plan_type")
  duration             PlanDuration
  status               SubscriptionStatus
  stripeSubscriptionId String               @unique @map("stripe_subscription_id")
  currentPeriodStart   DateTime             @map("current_period_start")
  currentPeriodEnd     DateTime             @map("current_period_end")
  cancelAtPeriodEnd    Boolean              @default(false) @map("cancel_at_period_end")
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")
  user                 User                 @relation(fields: [userId], references: [id])

  @@map("subscriptions")
}

model PlanCatalog {
  id            String               @id
  title         String
  subtitle      String
  priceLabel    String               @map("price_label")
  stripePriceId String               @map("stripe_price_id")
  planType      SubscriptionPlanType @map("plan_type")
  duration      PlanDuration
  active        Boolean              @default(true)

  @@map("plan_catalog")
}

model ActivationToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  tokenHash String    @unique @map("token_hash")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@index([expiresAt])
  @@map("activation_tokens")
}

enum UserRole {
  CLIENT
  COACH
  ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
  INCOMPLETE
}

enum SubscriptionPlanType {
  WOMAN_STARTER
  WOMAN_PREMIUM
  MAN_STARTER
  MAN_PREMIUM
}

enum PlanDuration {
  WEEKS_6  @map("6W")
  WEEKS_18 @map("18W")
  WEEKS_36 @map("36W")
}

enum OrderStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum SignUpStatus {
  PENDING
  ACTIVATED
  EXPIRED
}

enum EmailType {
  TRANSACTIONAL
  MARKETING
  SIGNUP
  PASSWORD_RESET
  WELCOME
}

enum EmailStatus {
  SENT
  FAILED
  DELIVERED
  OPENED
  BOUNCED
}
